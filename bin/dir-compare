#!/usr/bin/env sh
#
# Little script to allow for comparing two directories' files.

ignore_pattern=""
dir1=
dir2=

usage() {
    echo >&2 "  usage: $0 [-i|--ignore <pattern> ...] <dir1> <dir2>"
}

while [ $# -gt 0 ]; do
    case $1 in
        -i|--ignore)
            ignore_pattern+="! -iname $2 "
            shift
            shift
            ;;
        *)
            if [ $# -ne 2 ]; then
                usage
                exit 1
            fi
            dir1=$1
            dir2=$2
            shift
            shift
            ;;
    esac
done

# User passed in empty strings?
if [ -z "$dir1" ] || [ -z "$dir2" ]; then
    usage
    exit 2
fi

# Same path
if [ "$(cd $dir1 && pwd)" == "$(cd $dir2 && pwd)" ]; then
    exit
fi

d1=$(mktemp)
d2=$(mktemp)

find "$dir1" -type f $ignore_pattern -exec md5sum {} \; | sed "s:$dir1::" > $d1
find "$dir2" -type f $ignore_pattern -exec md5sum {} \; | sed "s:$dir2::" > $d2

sort $d1 | grep -v node_modules | grep -v .DS_Store > $d1.sorted
sort $d2 | grep -v node_modules | grep -v .DS_Store > $d2.sorted

rm $d1
rm $d2

diff $d1.sorted $d2.sorted | less --no-init --quit-if-one-screen

rm $d1.sorted
rm $d2.sorted
